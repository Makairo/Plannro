<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Plannro Calendar</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/index.global.min.js"></script>
</head>
<body>
  <div id="header-content">
    <h1>Plannro Calendar</h1>
    <div id="header-controls">
      <button id="themeToggle">Toggle Theme</button>
    </div>
  </div>

  <div id="calendar-container">
    <div id="calendar"></div>
  </div>

  <div id="addEventModal" class="modal">
    <div class="modal-content">
      <h3>New Event</h3>
      <input type="text" id="eventTitle" placeholder="Title" required />
      <textarea id="eventDesc" placeholder="Description"></textarea>
      <input type="date" id="eventDate" required />
      <input type="time" id="startTime" value="09:00" />
      <input type="time" id="endTime" />
      <div style="text-align:right">
        <button onclick="saveEvent()">Save</button>
        <button onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // Theme toggle
    const themeToggle = document.getElementById('themeToggle');
    const defaultTheme = 'dark';
    document.body.classList.add(`${defaultTheme}-theme`);
    let currentTheme = defaultTheme;

    themeToggle.addEventListener('click', () => {
      document.body.classList.remove(`${currentTheme}-theme`);
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.body.classList.add(`${currentTheme}-theme`);
    });

    // Modal
    const modal = document.getElementById('addEventModal');
    function openModal() { modal.style.display = 'flex'; }
    function closeModal() { modal.style.display = 'none'; }

    async function saveEvent() {
      const title = document.getElementById('eventTitle').value;
      const desc = document.getElementById('eventDesc').value;
      const date = document.getElementById('eventDate').value;
      const start = document.getElementById('startTime').value;
      const end = document.getElementById('endTime').value;

      if(!title||!date){ alert("Title and Date required"); return; }

      const eventData = { title, description: desc, eventDate: date, startTime: start, endTime: end };
      try {
        const response = await fetch('/events', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(eventData)});
        if(response.ok){ calendar.refetchEvents(); closeModal(); } 
        else { alert("Error saving event"); }
      } catch(err){ console.error(err); alert("Error saving event"); }
    }

    // Calendar
    document.addEventListener('DOMContentLoaded', function() {
      const calendarEl = document.getElementById('calendar');
      window.calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: '100%',
        headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay addEventButton' },
        customButtons: { addEventButton: {text: 'Create a New Event', click: openModal } },
        events: async function(fetchInfo, success, failure){
          try {
            const res = await fetch('/events');
            const events = await res.json();
            success(events.map(e=>({
              id:e.id,
              title:e.title,
              start:e.eventDate? e.eventDate+'T'+(e.startTime||'09:00:00'):null,
              end:e.eventDate&&e.endTime? e.eventDate+'T'+e.endTime:null,
              description:e.description
            })));
          } catch(err){ console.error(err); failure(err); }
        },
        eventClick: info => { alert('Event: '+info.event.title+'\nDescription: '+info.event.extendedProps.description); }
      });
      calendar.render();
    });
  </script>
</body>
</html>
